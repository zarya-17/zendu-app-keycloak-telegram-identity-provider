<!DOCTYPE html>
<html lang="en">
<head>
  <title>Login Page</title>
  <script type="text/javascript">
    const keycloakConfig = {
      realm: 'realm-name',
      clientId: 'client-name',
      keycloakUrl: 'keycloak-host',
      redirectUri: window.location.origin + '/path/to/login/page',
      telegram: 'telegram-idp-alias'
    };
    
    const authEndpoint = `${keycloakConfig.keycloakUrl}/realms/${keycloakConfig.realm}/protocol/openid-connect/auth`;
    const tokenEndpoint = `${keycloakConfig.keycloakUrl}/realms/${keycloakConfig.realm}/protocol/openid-connect/token`;
    
    const output = document.getElementById('output');
    const placeForNextButton = document.getElementById('placeForNextButton');
    
    // === Utility Functions ===
    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      window.crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    
    async function generateCodeChallenge(codeVerifier) {
      const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
      const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    
    function oauthFunc(provider) {
      return async () => {
        const codeVerifier = generateCodeVerifier();
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        localStorage.setItem('pkce_code_verifier', codeVerifier);
        
        const state = generateCodeVerifier();
        localStorage.setItem('state', state);
    
        const params = new URLSearchParams({
          response_type: 'code',
          client_id: keycloakConfig.clientId,
          redirect_uri: keycloakConfig.redirectUri,
          scope: 'openid profile email',
          code_challenge: codeChallenge,
          code_challenge_method: 'S256',
          kc_idp_hint: provider,
          state: state,
        });
    
        window.location.href = `${authEndpoint}?${params}`;
      }
    }
    
    // === OAuth2 Flow ===
    const telegramLoginBtn = document.getElementById('telegramLoginBtn');
    telegramLoginBtn.addEventListener('click', oauthFunc(keycloakConfig.telegram));
    
    // === Handle redirect with code ===
    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      console.log("state = ", state)
    
      if (!code) return;
    
      const codeVerifier = localStorage.getItem('pkce_code_verifier');
    
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        client_id: keycloakConfig.clientId,
        redirect_uri: keycloakConfig.redirectUri,
        code_verifier: codeVerifier,
      });
    
      const response = await fetch(tokenEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body,
      });
    
      const tokenResult = await response.json();
      console.log(tokenResult)
      output.innerText = JSON.stringify(tokenResult, null, 2);
      localStorage.removeItem('pkce_code_verifier');
      history.replaceState({}, document.title, window.location.pathname); // remove code from URL
    
      localStorage.setItem('token', tokenResult.access_token);
    }
    
    handleRedirect();
  </script>
</head>
<body>
  <h1>Login with Google via Keycloak</h1>
  <button id="telegramLoginBtn">Telegram Login</button>
  <pre id="output"></pre>
</body>
</html>
