<!DOCTYPE html>
<html>
    <head>
    <title>Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="text/javascript">
        const keycloakConfig = {
            realm: 'realm-name',
            clientId: 'client-name',
            keycloakUrl: 'keycloal-host',
            redirectUri: window.location.origin + '/path/to/mini-app',
            telegram: 'telegram-idp-alias'
        };
        
        const authEndpoint = `${keycloakConfig.keycloakUrl}/realms/${keycloakConfig.realm}/protocol/openid-connect/auth`;
        const tokenEndpoint = `${keycloakConfig.keycloakUrl}/realms/${keycloakConfig.realm}/protocol/openid-connect/token`;

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function generateCodeChallenge(codeVerifier) {
            const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
            const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function handleRedirect() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            console.log("state = ", state);

            if (!code) return;

            const codeVerifier = localStorage.getItem('pkce_code_verifier');

            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                client_id: keycloakConfig.clientId,
                redirect_uri: keycloakConfig.redirectUri,
                code_verifier: codeVerifier,
            });
            let response;
            try {
                response = await fetch(tokenEndpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body,
                });
            } catch (error) {
                alert(error);
            }

            const tokenResult = await response.json();
            const output = document.getElementById('output');
            output.innerText = JSON.stringify(tokenResult, null, 2);
            localStorage.removeItem('pkce_code_verifier');
            history.replaceState({}, document.title, window.location.pathname); // remove code from URL
        
            localStorage.setItem('token', tokenResult.access_token);
    }
        
        function utf8ToBase64(str) {
            const utf8Bytes = new TextEncoder().encode(str);
            const base64 = btoa(String.fromCharCode(...utf8Bytes));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("own-url").innerText = window.location;
            handleRedirect();
            document.getElementById("keycloak").innerText = keycloakConfig.keycloakUrl;
            const userInfo = document.getElementById("userInfo");
            const params = decodeURIComponent(window.Telegram.WebApp.initData);
            const authPayload = utf8ToBase64(params);
            userInfo.innerHTML = `info<br>${params}<br>init data: ${window.Telegram.WebApp.initData}<br>encoded<br>${authPayload}`

            const getTokenButton = document.getElementById("getToken");
            getTokenButton.addEventListener('click', async () => {
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                localStorage.setItem('pkce_code_verifier', codeVerifier);
                
                const state = generateCodeVerifier();
                localStorage.setItem('state', state);
                
                const params = new URLSearchParams({
                        response_type: 'code',
                        client_id: keycloakConfig.clientId,
                        redirect_uri: keycloakConfig.redirectUri,
                        scope: 'openid profile email',
                        code_challenge: codeChallenge,
                        code_challenge_method: 'S256',
                        kc_idp_hint: keycloakConfig.telegram,
                        state: state,
                        tg_encoded_data: authPayload
                });
            
                window.location.href = `${authEndpoint}?${params}`;
            });

            Telegram.WebApp.ready();
        });
        Telegram.WebApp.ready();
    </script>
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
    <h3>Mini App</h3>
    <a id="own-url"></a>
    <div id="keycloak"></div>
    <div id="userInfo"></div>
    <button id="getToken">Get token</button>
    <div id="output"></div>
</body>
</html>